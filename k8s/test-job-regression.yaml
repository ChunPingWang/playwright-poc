apiVersion: batch/v1
kind: Job
metadata:
  name: test-regression
  namespace: playwright-tests
  labels:
    app: playwright-test
    test-type: regression
    app.kubernetes.io/part-of: playwright-poc
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: playwright-test
        test-type: regression
    spec:
      restartPolicy: Never
      containers:
        - name: test-runner
          image: playwright-poc-test:latest
          imagePullPolicy: Never
          envFrom:
            - configMapRef:
                name: test-config
          command:
            - /bin/sh
            - -c
            - |
              echo "=== 回歸測試開始 ==="
              npx bddgen --config config/playwright.k8s.config.ts
              echo ">> 建立視覺回歸基準線（K8s 環境）..."
              npx playwright test --config=config/playwright.k8s.config.ts --grep @visual --update-snapshots --project=chromium 2>/dev/null || true
              echo ">> 執行完整回歸測試..."
              npx playwright test --config=config/playwright.k8s.config.ts --project=chromium
              TEST_EXIT=$?
              mkdir -p /reports/html-report /reports/test-results
              cp -r reports/* /reports/ 2>/dev/null || true
              cp -r playwright-report/* /reports/html-report/ 2>/dev/null || true
              cp -r test-results/* /reports/test-results/ 2>/dev/null || true
              echo "=== 回歸測試結束 (exit: $TEST_EXIT) ==="
              exit $TEST_EXIT
          volumeMounts:
            - name: reports
              mountPath: /reports
            - name: dshm
              mountPath: /dev/shm
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "1536Mi"
              cpu: "1500m"
      volumes:
        - name: reports
          persistentVolumeClaim:
            claimName: test-reports-pvc
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 256Mi
